## 마이크로서비스+ kafka + DB로 서비스 만들기

1. docker 네트워크 생성

`docker network create --gateway 172.19.0.1 --subnet 172.19.0.0/24 my-coffee-network`

-> 네트워크를 생성하고 같은 ip 대역 내에서 서비스들이 통신할 수 있게 한다

2. Docker에서 db 생성하기

`docker run -d -p 13306:3306 -e MYSQL_ALLOW_EMPTY_PASSWORD=true --network my-coffee-network--name mydb mysql:5.7`

```mysql
CREATE TABLE IF NOT EXISTS `delivery_status` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `delivery_id` varchar(50) DEFAULT NULL,
  `order_json` text DEFAULT NULL,
  `status` varchar(50) DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=utf8;

```

```mysql
CREATE TABLE IF NOT EXISTS `orders` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` varchar(100) NOT NULL,
  `order_id` varchar(100) NOT NULL,
  `coffee_name` varchar(100) NOT NULL,
  `coffee_price` int(11) NOT NULL,
  `coffee_qty` int(11) DEFAULT 1,
  `ordered_at` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=21 DEFAULT CHARSET=utf8;
```

2개의 필요한 테이블을 생성한다



3. 마이크로서비스 py파일을 생성한 후 dockerfile 생성

```dockerfile
FROM  python:3.7.9-stretch

WORKDIR /myflask

RUN pip install Flask
RUN pip install pymysql
RUN pip install flask-restful
COPY ./delivery_ms.py /myflask/app.py

CMD ["flask", "run","--host","0.0.0.0", "--port" ,"6000"]

#도커내에서 서버를 띄우면 host가 달라 127.0.0.1로 밖에 못들어오므로
# host 0.0.0.0로 설정해줘야함
```



이런식으로 ms에 대한 dockerfile 만들고 이미지 빌드하기



4. dockerfile로 이미지 빌드하기

` docker build -t cony56/flask_delivery_ms -f dockerfile_delivery . `



5. 이미지로 docker 컨테이너 생성하기

`docker run -d -p 16000:6000 --netowrk my-coffee-network cony56/flask_delivery_ms`

** network 설정해주는거 잊지 않기

6. Postman에서 rest api 명령어 사용하기

`http://127.0.0.1:16000/delivery-ms/deliveries`



